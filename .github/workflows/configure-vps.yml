name: Configure VPS
on:
  push:
  workflow_dispatch:
    inputs:
      create_seb_user:
        description: 'Create user seb (true/false)'
        required: false
        default: 'false'
      seb_password:
        description: 'Password for seb (required if creating user)'
        required: false
        default: ''
jobs:
  lint:
    name: 'Lint all files (shell, yaml, markdown, ansible)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js (for markdownlint)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Ansible community.general collection
        run: ansible-galaxy collection install community.general

      - name: Run ansible-lint
        uses: ansible/ansible-lint@main

      - name: Run yamllint
        uses: ansible-actions/yamllint-action@v0.0.2
        with:
          target: ./

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master

      - name: Run markdownlint
        uses: nosborn/github-action-markdown-cli@v3.5.0
        with:
          files: .

  check-port-22:
    name: 'Check if SSH port 22 is reachable'
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      port22_open: ${{ steps.check.outputs.port22_open }}
    steps:
      - name: Check port 22
        id: check
        run: |
          if nc -z -w5 ${{ secrets.VPS_HOST }} 22; then
            echo "port22_open=true" >> $GITHUB_OUTPUT
          else
            echo "port22_open=false" >> $GITHUB_OUTPUT
          fi

  change-ssh-port:
    name: '1. Change SSH Port to 10022'
    runs-on: ubuntu-latest
    needs: check-port-22
    if: needs.check-port-22.outputs.port22_open == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-


      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install 'ansible==2.19.*'
          ansible-galaxy collection install community.general

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPSZ_SSH_KEY }}

      - name: Change SSH port with Ansible (security only)
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=22" >> inventory
          ssh-keyscan -p 22 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          ansible-playbook -i inventory playbook.yml --tags security \
            --extra-vars "create_seb_user=${{ github.event.inputs.create_seb_user }} seb_password='${{ github.event.inputs.seb_password }}'"

  provision-server:
    name: '2. Provision Server on Port 10022'
    runs-on: ubuntu-latest
    needs: [check-port-22, change-ssh-port]
    if: needs.check-port-22.outputs.port22_open == 'false' || always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-


      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPSZ_SSH_KEY }}

      - name: Provision server with Ansible (all roles except security)
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=10022" >> inventory
          ssh-keyscan -p 10022 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          ansible-playbook -i inventory playbook.yml --skip-tags security \
            --extra-vars "create_seb_user=${{ github.event.inputs.create_seb_user }} seb_password='${{ github.event.inputs.seb_password }}'"
      - name: Print summary
        run: |
          echo "### VPS Configuration Summary"
          echo "- All roles in playbook.yml: common, security, web_management, monitoring, dev_tools"
          if [ '${{ needs.check-port-22.outputs.port22_open }}' = 'true' ]; then
            echo "- SSH port was changed from 22 to 10022 (security role executed)."
            echo "- Remaining roles (common, web_management, monitoring, dev_tools) were applied on port 10022."
          else
            echo "- SSH port 22 was not reachable. Only provisioning on port 10022 was performed."
            echo "- All roles except security were applied."
          fi

