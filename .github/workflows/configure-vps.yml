name: Configure VPS
on:
  push:
  workflow_dispatch:
    inputs:
      create_seb_user:
        description: 'Create user seb (true/false)'
        required: false
        default: 'false'
      seb_password:
        description: 'Password for seb (required if creating user)'
        required: false
        default: ''
jobs:
  lint:
    name: 'Lint all files (shell, yaml, markdown, ansible)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Ansible community.general collection
        run: ansible-galaxy collection install community.general --force --force

      - name: Run ansible-lint
        uses: ansible/ansible-lint@main

  check-port:
    name: 'Check which SSH port is open (22 or 10022)'
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      ssh_port: ${{ steps.check.outputs.ssh_port }}
    steps:
      - name: Check SSH ports
        id: check
        run: |
          if nc -z -w5 ${{ secrets.VPS_HOST }} 22; then
            echo "ssh_port=22" >> $GITHUB_OUTPUT
          elif nc -z -w5 ${{ secrets.VPS_HOST }} 10022; then
            echo "ssh_port=10022" >> $GITHUB_OUTPUT
          else
            echo "No SSH port open!" >&2
            exit 1
          fi

  change-ssh-port:
    name: '1. Change SSH Port to 10022'
    runs-on: ubuntu-latest
    needs: check-port
    if: needs.check-port.outputs.ssh_port == '22'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-


      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general --force

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPSZ_SSH_KEY }}

      - name: Change SSH port with Ansible (security only)
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=22" >> inventory
          ssh-keyscan -p 22 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # The SSH connection will be dropped after the port is changed; ignore the error so the workflow continues
          ansible-playbook -i inventory playbook.yml --tags security \
            --extra-vars "create_seb_user=${{ github.event.inputs.create_seb_user }} seb_password='${{ github.event.inputs.seb_password }}'" || true

  provision-server:
    name: '2. Provision Server'
    runs-on: ubuntu-latest
    needs: [check-port, change-ssh-port]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-


      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general --force

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPSZ_SSH_KEY }}

      - name: Debug SSH connection
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=${{ needs.check-port.outputs.ssh_port }}" >> inventory
          ssh-keyscan -p ${{ needs.check-port.outputs.ssh_port }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          echo "\n--- SSH DEBUG OUTPUT (port ${{ needs.check-port.outputs.ssh_port }}) ---\n"
          ssh -v -p ${{ needs.check-port.outputs.ssh_port }} -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} exit || true
          echo "\n--- END SSH DEBUG OUTPUT ---\n"

      - name: Provision server with Ansible (all roles except security)
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=${{ needs.check-port.outputs.ssh_port }}" >> inventory
          ssh-keyscan -p ${{ needs.check-port.outputs.ssh_port }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          ansible-playbook -i inventory playbook.yml --skip-tags security \
            --extra-vars "create_seb_user=${{ github.event.inputs.create_seb_user }} seb_password='${{ github.event.inputs.seb_password }}'"
      - name: Print summary
        run: |
          echo "### VPS Configuration Summary"
          echo "- All roles in playbook.yml: common, security, web_management, monitoring, dev_tools"
          echo "- Used SSH port ${{ needs.check-port.outputs.ssh_port }} for provisioning."
          if [ '${{ needs.check-port.outputs.ssh_port }}' = '22' ]; then
            echo "- SSH port 22 was open. Security role may have been skipped."
          else
            echo "- SSH port 10022 was open. Security role may have changed the port."
          fi

