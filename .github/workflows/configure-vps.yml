name: Configure VPS
on:
  push:
  workflow_dispatch:
    inputs:
      create_seb_user:
        description: 'Create user seb (true/false)'
        required: false
        default: 'false'
      seb_password:
        description: 'Password for seb (required if creating user)'
        required: false
        default: ''
jobs:
  lint:
    name: 'Lint all files (shell, yaml, markdown, ansible)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Ansible community.general collection
        run: ansible-galaxy collection install community.general --force --force

      - name: Run ansible-lint
        uses: ansible/ansible-lint@main

  check-port:
    name: 'Check which SSH port is open (22 or 10022)'
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      ssh_port: ${{ steps.check.outputs.ssh_port }}
      only_22_open: ${{ steps.check.outputs.only_22_open }}
    steps:
      - name: Check SSH ports
        id: check
        run: |
          port22_open=false
          port10022_open=false
          if nc -z -w5 ${{ secrets.VPS_HOST }} 22; then
            port22_open=true
          fi
          if nc -z -w5 ${{ secrets.VPS_HOST }} 10022; then
            port10022_open=true
          fi
          if [ "$port22_open" = true ] && [ "$port10022_open" = false ]; then
            echo "ssh_port=22" >> $GITHUB_OUTPUT
            echo "only_22_open=true" >> $GITHUB_OUTPUT
          elif [ "$port10022_open" = true ]; then
            echo "ssh_port=10022" >> $GITHUB_OUTPUT
            echo "only_22_open=false" >> $GITHUB_OUTPUT
          else
            echo "No SSH port open!" >&2
            exit 1
          fi

  change-ssh-port:
    name: '1. Change SSH Port to 10022 (if needed)'
    runs-on: ubuntu-latest
    needs: check-port
    if: needs.check-port.outputs.only_22_open == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general --force

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPSZ_SSH_KEY }}

      - name: Change SSH port with Ansible (security only)
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=22" >> inventory
          ssh-keyscan -p 22 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # The SSH connection will be dropped after the port is changed; ignore the error so the workflow continues
          ansible-playbook -i inventory playbook.yml --tags security \
            --extra-vars "create_seb_user=${{ github.event.inputs.create_seb_user }} seb_password='${{ github.event.inputs.seb_password }}'" || true

      - name: Thoroughly check SSH port change
        run: |
          echo "Checking if SSH port 10022 is open..."
          for i in {1..10}; do
            if nc -z -w5 ${{ secrets.VPS_HOST }} 10022; then
              echo "✅ SSH is up on port 10022!";
              break
            fi
            echo "Waiting for SSH on port 10022..."; sleep 3;
          done
          if ! nc -z -w5 ${{ secrets.VPS_HOST }} 10022; then
            echo "❌ ERROR: SSH is NOT available on port 10022 after port change!" >&2
            exit 1
          fi
          echo "Checking if SSH port 22 is still open..."
          if nc -z -w5 ${{ secrets.VPS_HOST }} 22; then
            echo "⚠️  WARNING: SSH is still open on port 22 after supposed port change!" >&2
          else
            echo "✅ SSH port 22 is closed as expected."
          fi

  provision-server:
    name: '2. Provision Server'
    runs-on: ubuntu-latest
    needs: [check-port, change-ssh-port]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general --force

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPSZ_SSH_KEY }}

      - name: Debug SSH connection
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=${{ needs.check-port.outputs.ssh_port }}" >> inventory
          ssh-keyscan -p ${{ needs.check-port.outputs.ssh_port }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          echo "\n--- SSH DEBUG OUTPUT (port ${{ needs.check-port.outputs.ssh_port }}) ---\n"
          ssh -v -p ${{ needs.check-port.outputs.ssh_port }} -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} exit || true
          echo "\n--- END SSH DEBUG OUTPUT ---\n"

      - name: Provision server with Ansible (all roles except security)
        run: |
          echo "[vps]" > inventory
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=${{ needs.check-port.outputs.ssh_port }}" >> inventory
          ssh-keyscan -p ${{ needs.check-port.outputs.ssh_port }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          ansible-playbook -i inventory playbook.yml --skip-tags security \
            --extra-vars "create_seb_user=${{ github.event.inputs.create_seb_user }} seb_password='${{ github.event.inputs.seb_password }}'"
      - name: Print summary
        run: |
          echo "### VPS Configuration Summary"
          echo "- All roles in playbook.yml: common, security, web_management, monitoring, dev_tools"
          echo "- Used SSH port ${{ needs.check-port.outputs.ssh_port }} for provisioning."
          if [ '${{ needs.check-port.outputs.ssh_port }}' = '22' ]; then
            echo "- SSH port 22 was open. Security role may have been skipped."
          else
            echo "- SSH port 10022 was open. Security role may have changed the port."
          fi

