name: Configure VPS

# Déclenche le workflow manuellement depuis l'onglet Actions de GitHub
on:
  workflow_dispatch:

jobs:
  change-ssh-port:
    name: 1 - Change SSH Port to 10022
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Setup Ansible
        run: |
          pip install ansible

      - name: Run Ansible to change SSH port
        run: |
          # Crée un inventaire dynamique pour se connecter sur le port 22
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=22" > inventory
          
          # Ajoute l'hôte à la liste des hôtes connus pour éviter la demande de confirmation
          ssh-keyscan -p 22 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

          # Exécute UNIQUEMENT les tâches de sécurité
          ansible-playbook -i inventory playbook.yml --tags security

  provision-server:
    name: 2 - Provision Server on Port 10022
    runs-on: ubuntu-latest
    needs: change-ssh-port # Ce job ne démarre que si le précédent a réussi

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
          
      - name: Setup Ansible
        run: |
          pip install ansible

      - name: Run Ansible to provision server
        run: |
          # Crée un inventaire dynamique pour se connecter sur le NOUVEAU port 10022
          echo "${{ secrets.VPS_HOST }} ansible_user=${{ secrets.VPS_USER }} ansible_port=10022" > inventory

          # Ajoute l'hôte sur le NOUVEAU port à la liste des hôtes connus
          ssh-keyscan -p 10022 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

          # Exécute tout le playbook SAUF les tâches de sécurité
          ansible-playbook -i inventory playbook.yml --skip-tags security
          
